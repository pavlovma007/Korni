# Korni _2 - НЕ ЗАВЕРШЕН

Идея проекта "корни 2" отличается от "корни 1": 

## Идея, Концепт

### Тезисы

1. Берется обычная база данных, с произвольными таблицами. 

2. вызывается утилита, которая оборачивает указанную таблицу, делая ее разделяемой

   ```bash
   $ ./korni2 <db path> <table name> # [secret branch, ... opts]
   ```

3. при этом в бд добавляются расширения и триггеры. 

4. при изменении данных : 

   1. таблица выгружается в виде дампа в "специальный файл в специальной папке", 
   2. происходит камит в локальную файловую базу
   3. разница (patch)  шифруется и дописывается в журнал
   4. опционально: 
      1. попытка забрать изменения из  main 
      2. попытка опубликовать "протолкнуть" изменения в main

5. если забраны изменения , то таблица загружается из дампа

6. если конфликт, то изменения не забираются и ваша ветка больше не может соединятся с другими - приложение само с этим должно разобраться. 

7. камиты подписанные юзером, который не зарегистрирован в приложении (особая таблица) система игнорирует. Изменения 



## Quick Start

```bash
$ ./korni2 wrap ~/.config/korni/db.sqlite J
```

обернуть таблицу `J` триггерами - теперь при изменнии данных, в таблице `_changes` будут отметки что она изменялась 



```bash
$ ./korni2 monitor ~/.config/korni/db.sqlite
```

начать мониторить базу и переносить изменения в шифрованные блоки в файлах. 





### Структура ПО: 

* **сама БД** делает дампы, камитит, в фоне: считает патчи , шифрует их , дописывает их в журнал , 
* **процесс забора изменений из журналов**: расшифровывает патчи, применяет их к нужным веткам, пытается смержить и обновить таблицы в БД если получилось
* *опционально* : локальный бекенд вашего приложения который работает с этой БД
* *опционально* : по синхронизации файлов журнала



### Структура на диске: 

* БД с данными и индексами 
* папка с дампами БД (можно их хранить в сжатом виде для компактности)
* локальный `.git`  репозитарий . для синхронизации баз используется мощь git. git merger умеет решать много конфликтов, имея историю (**но не все**)
* журналы, которые представляют собой дописываемые файлы с блоками шифрованных инкрементальных патчей между камитами git репозитария (формально: можно так распространять любой  произвольный git репозитарий, а не только репозитароий с дампами БД)

Помимо локального служебного git позитория существуют шифрованные компактные файлы журналов



## Преимущества

* произвольная структура БД, удобная разработчику приложения/ (этого не было в korni1)



## Интересные проекты

* https://github.com/harelba/q    text as data   [site](http://harelba.github.io/q/) 
* лазаем по файлам с sql https://github.com/cube2222/octosql
* лазаем по GIT репозитирию используя sql https://github.com/mergestat/mergestat 
* конструктор визуализаторов и панелей для данных
  * https://github.com/multiprocessio/datastation 
  * есть команд лайн инструмент для разных данных Commandline tool for running SQL queries against JSON, CSV, Excel, Parquet, and more. https://github.com/multiprocessio/dsq
* Datasette (python) - приложение для просмтора "всяких данных" в базе
  * video https://simonwillison.net/2021/Feb/7/video/
  * утилиты для работы с данными в sqlite https://sqlite-utils.datasette.io/en/stable/
  * github https://github.com/simonw/datasette





## Ход работы 



> **Идея**  все данные внутри дампа надо сразу же шифровать... или сам дамп ...  (шифровать при выгрузке дампа из БД на диск)
>
> **Надо , чтобы git объекты содержали уже шифрованные патчи и diff** 
>
> чтобы git можно было спокойно распространять и синхронизировать (он сам это умеет)



- [ ] `git upload-pack`  ?? как git  публикует  изменения

- [x] **команда - обернуть таблицы триггерами для логирования всех столбцов таблицы в специальный журнал**  https://blog.budgetwithbuckets.com/2018/08/27/sqlite-changelog.html

- [ ] **писать изменения таблиц в лог**

- [ ] 

- [ ] подключить к sqlite 

- [ ] **получить дамп таблицы в виде строк**

  - [ ] **триггер пишет имя таблицы в файл , который на самом деле `| pipe` который читает команда.** 

  - [ ] **команда делает дело : дамп итд далее по списку**

  - [ ] **через команды - лучше для большого размера https://stackoverflow.com/a/1938480/2355077** 

    ```bash
    $ sqlite3  ~/.config/korni/db.sqlite  ".dump J" | cat -n # sqlite readonly
    ```

    ```
    | grep '^INSERT INTO "tablename"'
    ```

  - [ ] через промежуточную строку https://github.com/nalgeon/sqlean/issues/27#issuecomment-1006791300

- [ ] сохранить дамп как файл https://github.com/nalgeon/sqlean/blob/main/docs/fileio.md

- [ ] **дамп построчно зашифровать**  lua crypto  - встроить скрипт в скрипт , собрать и чтобы работало

  - [ ] **best choise https://luarocks.org/modules/daurnimator/luaossl**

  - [ ] lua 5.1  https://luarocks.org/modules/starius/luacrypto

  - [ ] lua 5.2 - затруднительно 

  - ```
    luarocks install lockbox
    ```

- [ ] git 

  - [ ] **камит дампа**   а лучше создание блока внутри pack
  - [ ] выгрузка локальной ветки git  в шифрованные блоки
  - [ ] чтение шифрованных блоков и формирование других веток git. 
  - [ ] мерж себя в общую ветку - сохранить
    - [ ] мерж общей ветки в себя 

  * наверное полезное 
    - [ ] pack компактификация `git gc` 
      - [ ] https://stackoverflow.com/questions/5176225/are-gits-pack-files-deltas-rather-than-snapshots    
      - [ ] https://git-scm.com/book/en/v2/Git-Internals-Packfiles  

  - [ ] 
